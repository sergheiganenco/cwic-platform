name: cwic-platform

services:
  # ---------- FRONTEND ----------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    command: npm run dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      VITE_API_URL: http://localhost:8000
    depends_on:
      api-gateway:
        condition: service_started
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:5173/',r=>{process.exit(r.statusCode>=200 && r.statusCode<500?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- API GATEWAY ----------
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile.dev
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 8000
      DATA_SERVICE_URL: http://data-service:3002
      AI_SERVICE_URL: http://ai-service:3003
      AUTH_SERVICE_URL: http://auth-service:3001
      PIPELINE_SERVICE_URL: http://pipeline-service:3004
      INTEGRATION_SERVICE_URL: http://integration-service:3005
      QUALITY_ENGINE_URL: http://quality-engine:3010
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
      # DEV_BEARER removed for security
      NO_PROXY: "localhost,127.0.0.1,api-gateway,data-service,ai-service,auth-service,pipeline-service,notification-service,integration-service,db,redis"
      no_proxy: "localhost,127.0.0.1,api-gateway,data-service,ai-service,auth-service,pipeline-service,notification-service,integration-service,db,redis"
    ports:
      - "8000:8000"
    # Run tsx directly (deps are already baked into the image)
    command: tsx --enable-source-maps src/server.ts
    volumes:
      # Mount ONLY the files you edit; DO NOT mount package.json/lock or /app/node_modules
      - ./backend/api-gateway/src:/app/src
      - ./backend/api-gateway/tsconfig.json:/app/tsconfig.json
    depends_on:
      data-service:
        condition: service_healthy
      ai-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:8000/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    networks:
      - cwic-network



  # ---------- AUTH SERVICE ----------
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    ports:
      - "3001:3001"                                   # <— expose 3001 not 8001
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 3001                                      # <— listen on 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-cwic_user}:${POSTGRES_PASSWORD:-cwic_secure_pass}@db:5432/${POSTGRES_DB:-cwic_platform}
      REDIS_URL: redis://:${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}@redis:6379/0
      JWT_SECRET: ${DATA_SERVICE_JWT_SECRET:-change-me}
      CONNECTION_ENCRYPTION_KEY: ${CONNECTION_ENCRYPTION_KEY:-change-me-too}
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3001/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- DATA SERVICE ----------
  data-service:
    build:
      context: ./backend/data-service
      dockerfile: Dockerfile.dev
    command: ["npm","run","dev"]
    ports: ["3002:3002"]
    environment:
      NODE_ENV: development
      SKIP_AUTH: ${DATA_SERVICE_SKIP_AUTH:-false}
      JWT_SECRET: ${DATA_SERVICE_JWT_SECRET:-change-me}
      PORT: 3002
      HOST: 0.0.0.0
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-cwic_user}:${POSTGRES_PASSWORD:-cwic_secure_pass}@db:5432/${POSTGRES_DB:-cwic_platform}}
      ENABLE_FILE_LOGGING: "false"
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
      CHOKIDAR_USEPOLLING: "1"
      CHOKIDAR_INTERVAL: "300"
      REDIS_URL: redis://:${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}@redis:6379/0
    volumes:
      - ./backend/data-service:/app
      - /app/node_modules
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD","node","-e","require('http').get('http://127.0.0.1:3002/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    networks:
      - cwic-network

  # ---------- AI SERVICE ----------
  ai-service:
    build:
      context: ./backend/ai-service
      dockerfile: Dockerfile.dev
    ports: ["3003:3003"]
    environment:
      NODE_ENV: development
      PORT: 3003
      HOST: 0.0.0.0
      IS_DOCKER: true
      API_GATEWAY_URL: http://api-gateway:8000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes:
      - ./backend/ai-service:/app
      - /app/node_modules
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3003/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""
        ]
      interval: 10s
      timeout: 3s
      start_period: 15s
      retries: 3
    networks:
      - cwic-network

  # ---------- PIPELINE SERVICE ----------
  pipeline-service:
    build:
      context: ./backend/pipeline-service
      dockerfile: Dockerfile.dev
    command: ["npm","run","dev"]
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 3004
      SERVICE_NAME: pipeline-service
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-cwic_user}:${POSTGRES_PASSWORD:-cwic_secure_pass}@db:5432/${POSTGRES_DB:-cwic_platform}}
      REDIS_URL: redis://:${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}@redis:6379/0
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}
      DATA_SERVICE_URL: http://data-service:3002
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
      SKIP_AUTH: ${DATA_SERVICE_SKIP_AUTH:-false}
      PIPELINE_WORKER_CONCURRENCY: 2
    ports:
      - "3004:3004"
    volumes:
      - ./backend/pipeline-service:/app
      - /app/node_modules
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      data-service:
        condition: service_healthy
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3004/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1)}\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- NOTIFICATION SERVICE ----------
  notification-service:
    build:
      context: ./backend/notification-service
      dockerfile: Dockerfile.dev
    command: ["npm","run","dev"]
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 3005
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
    ports:
      - "3005:3005"
    volumes:
      - ./backend/notification-service:/app
      - /app/node_modules
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3005/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- INTEGRATION SERVICE (Agentic AI) ----------
  integration-service:
    build:
      context: ./backend/integration-service
      dockerfile: Dockerfile.dev
    command: ["npm","run","dev"]
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      PORT: 3005
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
      # Agentic AI Configuration
      USE_MOCKS: "true"
      ENABLE_AI: "false"
      AUTO_REMEDIATE: "true"
      VERIFY_WEBHOOKS: "false"
      # Service URLs
      PIPELINE_SERVICE_URL: http://pipeline-service:3004
      DATA_SERVICE_URL: http://data-service:3002
      AI_SERVICE_URL: http://ai-service:3003
      # External integrations (configure in .env for production)
      # JIRA_URL: https://your-company.atlassian.net
      # JIRA_USERNAME: your-email@company.com
      # JIRA_API_TOKEN: your-token
      # JIRA_PROJECT: DATA
      # SERVICENOW_INSTANCE: your-instance.service-now.com
      # SERVICENOW_USERNAME: admin
      # SERVICENOW_PASSWORD: your-password
      # AZURE_DEVOPS_ORGANIZATION: your-org
      # AZURE_DEVOPS_PROJECT: your-project
      # AZURE_DEVOPS_TOKEN: your-pat
      # GITHUB_WEBHOOK_SECRET: your-secret
      # OPENAI_API_KEY: sk-your-key
    ports:
      - "3005:3005"
    volumes:
      - ./backend/integration-service:/app
      - /app/node_modules
    depends_on:
      - pipeline-service
      - data-service
      - ai-service
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3005/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- QUALITY ENGINE ----------
  quality-engine:
    build:
      context: ./backend/quality-engine
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      HOST: 0.0.0.0
      QUALITY_ENGINE_PORT: 3010
      SERVICE_NAME: quality-engine
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-cwic_platform}
      DB_USER: ${POSTGRES_USER:-cwic_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-cwic_secure_pass}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}
      CORS_ORIGIN: http://localhost:5173,http://localhost:3000
      # ML Configuration
      ML_ANOMALY_THRESHOLD: 0.95
      ML_RETRAIN_FREQUENCY: weekly
      # Cost Limits
      DAILY_COST_LIMIT: 100
      MONTHLY_COST_LIMIT: 2000
      # Observability
      LOG_LEVEL: info
      OTEL_EXPORTER_OTLP_ENDPOINT: http://localhost:4318
    ports:
      - "3010:3010"
    volumes:
      - ./backend/quality-engine:/app
      - /app/node_modules
      - quality-engine-logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      data-service:
        condition: service_healthy
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3010/health',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------- POSTGRES ----------
  db:
    image: postgres:15
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${DB_NAME:-cwic_platform}
      POSTGRES_USER: ${DB_USER:-cwic_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cwic_secure_pass}
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-cwic_user} -d ${DB_NAME:-cwic_platform} -h localhost || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cwic-network
    restart: unless-stopped

  # ---------- REDIS ----------
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --requirepass
      - ${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-sPokmqwvACzMaFvHYFHbb9SUgEnd5oX6tCurvAxBOdY=}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cwic-network
    restart: unless-stopped

  # ---------- OPTIONAL: ELASTICSEARCH ----------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    profiles: ["search"]
    environment:
      discovery.type: single-node
      xpack.security.enabled: "true"
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-El@st1c_S3cur3_P@ss_2025!}
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    ports:
      - "9200:9200"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    networks:
      - cwic-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:9200/_cluster/health?wait_for_status=yellow&timeout=1s',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""
        ]
      interval: 30s
      timeout: 10s
      retries: 10

networks:
  cwic-network:
    driver: bridge

volumes:
  pgdata:
  redisdata:
  quality-engine-logs:







