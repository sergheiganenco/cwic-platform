FROM node:20-alpine

WORKDIR /app
RUN apk add --no-cache curl

COPY package*.json ./
RUN if [ -s package-lock.json ] && grep -q '"lockfileVersion"' package-lock.json; then \
    npm ci --no-audit --no-fund; \
    else \
    echo "No valid package-lock.json → using npm install"; \
    npm install --no-audit --no-fund; \
    fi

# Ensure tsx exists even if not hoisted into PATH
RUN npm i -g tsx@4

COPY tsconfig.json ./tsconfig.json
COPY src ./src

ENV NODE_ENV=development
ENV HOST=0.0.0.0
ENV PORT=8000

EXPOSE 8000
CMD ["tsx", "--enable-source-maps", "src/server.ts"]
